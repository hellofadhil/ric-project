@model OnePro.Front.Models.RicCreateViewModel
@{
    ViewBag.Title = "Form RIC New Development & Enhancement";
    Layout = "_LayoutDashboard";
}

<div class="min-h-screen bg-slate-50">
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

        @using (Html.BeginForm("Create", "Ric", FormMethod.Post, new { enctype = "multipart/form-data" }))
        {
            <div class="bg-white rounded-2xl shadow-sm ring-1 ring-slate-200/80 overflow-hidden">

                <!-- HEADER: Informasi Umum -->
                <div class="border-b border-slate-100 bg-white px-8 py-4">
                    <p class="text-[11px] font-semibold tracking-wide text-slate-500 uppercase">
                        Informasi Umum
                    </p>
                </div>

                <div class="p-8 space-y-8">

                    @Html.EditorFor(m => m.JudulPermintaan, "TextInput", new {
                        Label = "Judul Permintaan",
                        Required = true,
                        Placeholder = "Digitalisasi proses pengajuan IT equipment",
                        HelpText = "Bikin judul yang singkat tapi straight to the point."
                    })

                    <!-- HASHTAG -->
                    <div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-800">
                            Hashtag
                        </label>

                        <div class="rounded-lg border border-dashed border-slate-200 bg-white px-4 py-3">
                            <div id="hashtag-badges" class="flex flex-wrap gap-2 mb-2">
                                @if (Model.Hashtags != null && Model.Hashtags.Any())
                                {
                                    for (var i = 0; i < Model.Hashtags.Count; i++)
                                    {
                                        <span class="tag-badge inline-flex items-center gap-1 rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700 border border-indigo-100">
                                            <span>#@Model.Hashtags[i]</span>
                                            <button type="button"
                                                    class="tag-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-indigo-100 text-[10px] text-indigo-600"
                                                    data-tag="@Model.Hashtags[i]">
                                                ×
                                            </button>
                                            <input type="hidden" name="Hashtags[@i]" value="@Model.Hashtags[i]" />
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="text-xs text-slate-400 empty-hashtag-placeholder">
                                        Belum ada hashtag. Tambahin buat ngelompokkin RIC lo.
                                    </span>
                                }
                            </div>

                            <input id="hashtag-input"
                                type="text"
                                class="w-full border-0 bg-transparent px-0 py-2 text-base text-slate-900 placeholder:text-slate-400 focus:ring-0 focus:outline-none"
                                placeholder="Ketik hashtag lalu tekan Enter"
                                autocomplete="off" />
                        </div>

                        <p class="text-xs text-slate-400">
                            Tanpa spasi. Contoh: product_deployment.
                        </p>
                    </div>

                    @Html.EditorFor(m => m.AsIsRasciFile, "FileInput", new {
                        Label = "As-Is Process RASCI File",
                        Title = "Upload file",
                        Subtitle = "Format: PDF / PPTX / DOCX, max 10MB.",
                        IconColor = "bg-indigo-100 text-indigo-600"
                    })
                </div>

                <!-- Permasalahan & Alternatif -->
                <div class="border-y border-slate-100 bg-white px-8 py-4">
                    <p class="text-[11px] font-semibold tracking-wide text-slate-500 uppercase">
                        Permasalahan & Alternatif Solusi
                    </p>
                </div>

                <div class="p-8 space-y-8">

                    @Html.EditorFor(m => m.Permasalahan, "TextAreaInput", new {
                        Label = "Permasalahan",
                        Required = true,
                        Rows = 4,
                        Placeholder = "Jelaskan masalah utama..."
                    })

                    @Html.EditorFor(m => m.DampakMasalah, "TextAreaInput", new {
                        Label = "Dampak Masalah",
                        Rows = 3,
                        Placeholder = "Contoh: keterlambatan approval..."
                    })

                    @Html.EditorFor(m => m.FaktorPenyebab, "TextAreaInput", new {
                        Label = "Faktor Penyebab",
                        Rows = 3
                    })

                    @Html.EditorFor(m => m.SolusiSaatIni, "TextAreaInput", new {
                        Label = "Solusi Saat Ini",
                        Rows = 3
                    })

                    <!-- ALTERNATIF -->
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <h2 class="text-sm font-semibold text-slate-900">
                                Alternatif Solusi
                            </h2>
                            <span class="rounded-full bg-indigo-50 px-3 py-1 text-[11px] font-medium text-indigo-700">
                                Minimal 1
                            </span>
                        </div>

                        <div class="rounded-lg border border-dashed border-slate-200 bg-white px-4 py-3">
                            <div id="alternatif-badges" class="flex flex-wrap gap-2 mb-2">
                                @if (Model.Alternatifs != null && Model.Alternatifs.Any())
                                {
                                    for (var i = 0; i < Model.Alternatifs.Count; i++)
                                    {
                                        <span class="alt-badge inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-100">
                                            <span>@Model.Alternatifs[i]</span>
                                            <button type="button"
                                                    class="alt-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-[10px] text-emerald-600"
                                                    data-alt="@Model.Alternatifs[i]">
                                                ×
                                            </button>
                                            <input type="hidden" name="Alternatifs[@i]" value="@Model.Alternatifs[i]" />
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="text-xs text-slate-400 empty-alt-placeholder">
                                        Belum ada alternatif.
                                    </span>
                                }
                            </div>

                            <textarea id="alternatif-input"
                                rows="2"
                                class="w-full border-0 bg-transparent px-0 py-2 text-base text-slate-900 placeholder:text-slate-400 focus:ring-0 focus:outline-none resize-none"
                                placeholder="Ketik alternatif lalu tekan Enter..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- To-Be -->
                <div class="border-y border-slate-100 bg-white px-8 py-4">
                    <p class="text-[11px] font-semibold tracking-wide text-slate-500 uppercase">
                        To-Be & Value
                    </p>
                </div>

                <div class="p-8 space-y-8">

                    @Html.EditorFor(m => m.ToBeProcessFile, "FileInput", new {
                        Label = "To-Be Process Business + RASCI + KKI",
                        IconColor = "bg-emerald-100 text-emerald-600"
                    })

                    @Html.EditorFor(m => m.PotentialValue, "TextAreaInput", new {
                        Label = "Potential Value",
                        Rows = 3
                    })

                    @Html.EditorFor(m => m.ExpectedCompletionFile, "FileInput", new {
                        Label = "Expected Completion",
                        IconColor = "bg-amber-100 text-amber-600"
                    })

                    @Html.EditorFor(m => m.HasilSetelahPerbaikan, "TextAreaInput", new {
                        Label = "Hasil Setelah Perbaikan",
                        Rows = 3
                    })
                </div>

                <!-- BUTTON FOOTER -->
                <div class="flex flex-col gap-4 border-t border-slate-100 bg-white px-8 py-4 sm:flex-row sm:items-center sm:justify-between">

                    <button type="reset"
                        class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 hover:text-slate-700">
                        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-slate-300 text-[11px]">
                            ↺
                        </span>
                        Reset
                    </button>

                    <div class="flex items-center gap-3">
                        <button type="submit" name="action" value="save"
                            class="inline-flex items-center justify-center rounded-lg border border-slate-300 bg-white px-5 py-2.5 text-sm font-medium text-slate-700 shadow-sm hover:bg-slate-100 transition">
                            Simpan Draft
                        </button>

                        <button type="submit" name="action" value="submit"
                            class="inline-flex items-center justify-center rounded-lg border border-indigo-600 bg-indigo-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 transition">
                            Ajukan RIC
                        </button>
                    </div>
                </div>
            </div>
        }

        @section Scripts {
            <script>
                // ===== HASHTAG =====
                (function () {
                    const badgesContainer = document.getElementById('hashtag-badges');
                    const input = document.getElementById('hashtag-input');

                    function createTagBadge(tag) {
                        tag = tag.trim();
                        if (!tag) return;

                        const exists = badgesContainer.querySelector('input[type="hidden"][value="' + tag + '"]');
                        if (exists) return;

                        const index = badgesContainer.querySelectorAll('input[type="hidden"]').length;

                        const placeholder = badgesContainer.querySelector('.empty-hashtag-placeholder');
                        if (placeholder) placeholder.remove();

                        const span = document.createElement('span');
                        span.className = 'tag-badge inline-flex items-center gap-1 rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-medium text-indigo-700 border border-indigo-100';

                        span.innerHTML =
                            '<span>#' + tag + '</span>' +
                            '<button type="button" class="tag-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-indigo-100 text-[10px] text-indigo-600" data-tag="' + tag + '">×</button>' +
                            '<input type="hidden" name="Hashtags[' + index + ']" value="' + tag + '" />';

                        badgesContainer.appendChild(span);
                    }

                    input?.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const value = input.value.replace(/^#+/, '');
                            if (value.trim()) {
                                createTagBadge(value);
                                input.value = '';
                            }
                        }
                    });

                    badgesContainer?.addEventListener('click', function (e) {
                        if (e.target.classList.contains('tag-remove')) {
                            const badge = e.target.closest('.tag-badge');
                            badge?.remove();

                            const hiddenInputs = badgesContainer.querySelectorAll('input[type="hidden"]');
                            hiddenInputs.forEach((inp, idx) => {
                                inp.name = 'Hashtags[' + idx + ']';
                            });

                            if (hiddenInputs.length === 0) {
                                const span = document.createElement('span');
                                span.className = 'text-xs text-slate-400 empty-hashtag-placeholder';
                                span.textContent = 'Belum ada hashtag. Tambahin.';
                                badgesContainer.appendChild(span);
                            }
                        }
                    });
                })();

                // ===== ALTERNATIF =====
                (function () {
                    const badgesContainer = document.getElementById('alternatif-badges');
                    const input = document.getElementById('alternatif-input');

                    function createAltBadge(text) {
                        text = text.trim();
                        if (!text) return;

                        const index = badgesContainer.querySelectorAll('input[type="hidden"]').length;

                        const placeholder = badgesContainer.querySelector('.empty-alt-placeholder');
                        if (placeholder) placeholder.remove();

                        const span = document.createElement('span');
                        span.className = 'alt-badge inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700 border border-emerald-100';

                        span.innerHTML =
                            '<span>' + text + '</span>' +
                            '<button type="button" class="alt-remove inline-flex h-4 w-4 items-center justify-center rounded-full bg-emerald-100 text-[10px] text-emerald-600" data-alt="' + text + '">×</button>' +
                            '<input type="hidden" name="Alternatifs[' + index + ']" value="' + text + '" />';

                        badgesContainer.appendChild(span);
                    }

                    input?.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const lines = input.value.split('\n');
                            lines.forEach(line => createAltBadge(line));
                            input.value = '';
                        }
                    });

                    badgesContainer?.addEventListener('click', function (e) {
                        if (e.target.classList.contains('alt-remove')) {
                            const badge = e.target.closest('span.alt-badge');
                            badge?.remove();

                            const hiddenInputs = badgesContainer.querySelectorAll('input[type="hidden"]');
                            hiddenInputs.forEach((inp, idx) => {
                                inp.name = 'Alternatifs[' + idx + ']';
                            });

                            if (hiddenInputs.length === 0) {
                                const span = document.createElement('span');
                                span.className = 'text-xs text-slate-400 empty-alt-placeholder';
                                span.textContent = 'Belum ada alternatif.';
                                badgesContainer.appendChild(span);
                            }
                        }
                    });
                })();
            </script>
        }
    </div>
</div>
